# Check efi modus
efivar -l

# Check dhcp connection
ping 8.8.8.8

# Get neo keyboard layout
wget https://svn.neo-layout.org/linux/console/neo.map
gzip neo.map
mkdir /usr/share/kbd/keymaps/i386/neo
mv neo.map.gz /usr/share/kbd/keymaps/i386/neo/
localectl --no-convert set-keymap neo

# Update the system clock
timedatectl set-ntp true

# Load dm-crpyt module
modprobe dm-crypt
modprobe dm-mod
modprobe raid1

# Prepare storage for lvm on luks on raid1
gdisk /dev/sdx
    o
    n
    1
    [ENTER]
    +512M
    ef00

    n
    [ENTER]
    [ENTER]
    -100M
    fd00

    w

# Setup raid array
mdadm --create /dev/md0 --level=1 --raid-devices=2 /dev/sd[ab]2

## See progress
watch -n1 cat /proc/mdstat

## See if everything went right
mdadm --misc --detail /dev/md[01] | less

# Encryption
cryptsetup benchmark

cryptsetup --cipher aes-xts-plain64 --key-size 512 --hash sha512 --iter-time 5000 --use-urandom -y luksFormat /dev/md0
cryptsetup luksOpen /dev/md0 lvm

# Create logical encrypted partitions
pvcreate /dev/mapper/lvm
vgcreate arch /dev/mapper/lvm

lvcreate -L 64G -n root arch
lvcreate -L 1536G -n home arch

# Format volumes
mkfs.btrfs /dev/mapper/arch-root
mkfs.ext4 /dev/mapper/arch-home
mkfs.fat -F32 /dev/sda1
mkfs.fat -F32 /dev/sdb1

# Mount partitions
mount -o compress=lzo,space_cache,autodefrag,inode_cache /dev/mapper/arch-root /mnt
mkdir /mnt/boot
mkdir /mnt/home
mount /dev/mapper/arch-home /mnt/home
mount /dev/sda1 /mnt/boot

# Install base system
vim /etc/pacman.d/mirrorlist # Change ordering
pacstrap -i /mnt base base-devel

mdadm --examine --scan > /mnt/etc/mdadm.conf
genfstab -U /mnt >> /mnt/etc/fstab

vim /etc/mkinitcpio.conf
 MODULES="... dm_mod dm_crypt aes_x86_64 raid1 ..."
 HOOKS="base udev autodetect modconf block mdadm_udev keyboard keymap encrypt lvm2 filesystems fsck"

vi /etc/rc.conf
 USELVM="yes"
 USEDMRAID="yes"

# Change root into the new system
arch-chroot /mnt /bin/bash

# Locales
vi /etc/locale.gen
    de_DE.UTF-8 UTF-8
    en_US.UTF-8 UTF-8

locale-gen
echo LANG=en_US.UTF-8 > /etc/locale.conf

# Keymap
vi /etc/vconsole.conf
    KEYMAP=neo
    FONT=Lat2-Terminus16

# Time
ln -s /usr/share/zoneinfo/Europe/Berlin /etc/localtime
hwclock --systohc --utc

# Hostname
echo [hostname] > /etc/hostname
vim /etc/hosts
    # append [hostname]

# Internet
systemctl enable dhcpcd@enpXsY.service

# Initramfs
pacman -S btrfs-progs vim
vi /etc/mkinitcpio.conf
HOOKS="base udev autodetect modconf block keyboard keymap encrypt lvm2 filesystems fsck"
mkinitcpio -p linux

bootctl install

vim /boot/loader/entries/arch.conf
    title Arch Linux Encrypted
    linux /vmlinuz-linux
    initrd /initramfs-linux.img
    options cryptdevice=/dev/md0:arch root=/dev/mapper/arch-root rw

vim /boot/loader/loader.conf
    timeout 3
    default arch

# set root password
passwd

# exit and reboot
exit
umount -R /mnt/
reboot  # plug off usb-stick
