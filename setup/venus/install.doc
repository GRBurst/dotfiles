# Check dhcp connection
ping 8.8.8.8

# Get neo keyboard layout
wget https://svn.neo-layout.org/linux/console/neo.map
gzip neo.map
mkdir /usr/share/kbd/keymaps/i386/neo
cp neo.map.gz /usr/share/kbd/keymaps/i386/neo/
localectl --no-convert set-keymap neo

# Update the system clock
timedatectl set-ntp true

# Load dm-crpyt module
modprobe dm-crypt
modprobe dm-mod
modprobe raid1

# Prepare storage for lvm on luks on raid1
gdisk /dev/sd[xy]
    o

    n
    [ENTER]
    [ENTER]
    +256M
    fd00

    n
    [ENTER]
    [ENTER]
    -100M
    fd00

    w

# Setup raid array
mdadm --create /dev/md0 --level=1 --raid-devices=2 --metadata=1.0 /dev/sd[xy]1
mdadm --create /dev/md1 --level=1 --raid-devices=2 /dev/sd[xy]2

## See progress
watch -n1 cat /proc/mdstat

## See if everything went right
mdadm --misc --detail /dev/md[01] | less

# Encryption
cryptsetup benchmark

cryptsetup --cipher aes-xts-plain64 --key-size 512 --hash sha512 --iter-time 5000 --use-urandom -y luksFormat /dev/md1
cryptsetup luksOpen /dev/md1 lvm

# Create logical encrypted partitions
pvcreate /dev/mapper/lvm
vgcreate arch /dev/mapper/lvm

lvcreate -L 32G -n root arch
lvcreate -C d -L 8G -n swap arch
lvcreate -L 200G -n home arch
# lvcreate -l 100%FREE -n home arch

lvdisplay

# Format volumes
mkfs.ext2 -L boot /dev/md0
mkfs.btrfs -L root /dev/mapper/arch-root
mkfs.ext4 -L home /dev/mapper/arch-home
mkswap -L swap /dev/mapper/arch-swap

# Mount partitions
mount -o compress=lzo,space_cache,autodefrag,inode_cache /dev/mapper/arch-root /mnt
mkdir /mnt/boot
mkdir /mnt/home
mount /dev/mapper/arch-home /mnt/home
mount /dev/md0 /mnt/boot
swapon /dev/mapper/arch-swap

# Install base system
vim /etc/pacman.d/mirrorlist # Change ordering
pacstrap -i /mnt base base-devel

mdadm --examine --scan > /mnt/etc/mdadm.conf
genfstab -U /mnt >> /mnt/etc/fstab

# Neo keymaps
mkdir /mnt/usr/share/kbd/keymaps/i386/neo
cp neo.map.gz /mnt/usr/share/kbd/keymaps/i386/neo/

# Change root into the new system
arch-chroot /mnt /bin/bash

localectl --no-convert set-keymap neo
pacman -S neovim

nvim /etc/mkinitcpio.conf
 MODULES="... dm_mod dm_crypt aes_x86_64 raid1 ..."
 HOOKS="base udev autodetect modconf block mdadm_udev keyboard keymap encrypt lvm2 filesystems fsck"

vi /etc/rc.conf
 USELVM="yes"
 USEDMRAID="yes"

# Locales
vi /etc/locale.gen
    de_DE.UTF-8 UTF-8
    en_US.UTF-8 UTF-8

locale-gen
echo LANG=en_US.UTF-8 > /etc/locale.conf

# Keymap
vi /etc/vconsole.conf
    KEYMAP=neo
    FONT=Lat2-Terminus16

# Time
ln -s /usr/share/zoneinfo/Europe/Berlin /etc/localtime
hwclock --systohc --utc

# Hostname
echo [hostname] > /etc/hostname
nvim /etc/hosts
    # append [hostname]

# Dhcp
systemctl enable dhcpcd@enpXsY.service

# Microcode
pacman -S intel-ucode

# Initramfs
pacman -S btrfs-progs nvim
vi /etc/mkinitcpio.conf
HOOKS="base udev autodetect modconf block mdadm_udev keyboard keymap encrypt lvm2 filesystems fsck"
mkinitcpio -p linux

# Bootloader
pacman -S syslinux gptfdisk
syslinux-install_update -i -a -m #fail? -> manual will work
nvim /boot/syslinux/syslinux.cfg
    APPEND cryptdevice=/dev/md1:arch root=/dev/mapper/arch-root rw
    INITRD ../intel-ucode.img,../initramfs-linux.img

# set root password
passwd

# exit and reboot
exit
umount -R /mnt/
reboot  # plug off usb-stick





# pacman -S grub

# nvim /etc/default/grub
#     GRUB_CMDLINE_LINUX="cryptdevice=/dev/md1:arch root=/dev/mapper/arch-root"
#     GRUB_PRELOAD_MODULES="lvm mdraid"
#     GRUB_ENABLE_CRYPTODISK=y

# grub-mkconfig -o /boot/grub/grub.cfg

# nvim /boot/grub/grub.cfg
#     change root to
#     set root=(md/1)

# bootctl install

# nvim /boot/loader/entries/arch.conf
#     title Arch Linux Encrypted
#     linux /vmlinuz-linux
#     initrd /initramfs-linux.img
#     options cryptdevice=/dev/md0:arch root=/dev/mapper/arch-root rw

# nvim /boot/loader/loader.conf
#     timeout 3
#     default arch
